<!DOCTYPE html>
<meta charset="utf-8">

<body>
  <!-- <canvas id="c"></canvas> -->
  <script src="./js/lodash.min.js"></script>
  <script type="module">
    import * as _3js from '../three/build/three.module.js';
    import {EffectComposer} from '../three/examples/jsm/postprocessing/EffectComposer.js';
    import { RenderPass } from "../three/examples/jsm/postprocessing/RenderPass.js";
    // import { CustomOutlinePass } from "./three/CustomOutlinePass.js";
    import { ShaderPass } from "../three/examples/jsm/postprocessing/ShaderPass.js";
    import { FXAAShader } from "../three/examples/jsm/shaders/FXAAShader.js";
    import { Control } from "./three/control.js";
    import {line} from "./three/line.js";
    import * as alt0 from './three/shape0.js';
    import * as utilm from './three/util.js';
    import * as doug from "./three/test.js";

    var shaper0 = new alt0.shaper();
    var util = new utilm.util();
    util.constructor();
    shaper0.constructor();

    function main() {
      _3js.Object3D.DefaultUp = new _3js.Vector3(0,0,1);
      const renderer = new _3js.WebGLRenderer({antialias: true});
      renderer.setSize(1800, 900);
      // renderer.physicallyCorrectLights = true;
      // renderer.shadowMap.enabled = true;
      // renderer.shadowMap.type = _3js.PCFSoftShadowMap;
      // renderer.shadowMap.renderReverseSided = false;
      document.body.appendChild( renderer.domElement );

      // Set up post processing
      // Create a render target that holds a depthTexture so we can use it in the outline pass
      // See: https://threejs.org/docs/index.html#api/en/renderers/WebGLRenderTarget.depthBuffer
      const depthTexture = new _3js.DepthTexture();
      const renderTarget = new _3js.WebGLRenderTarget(
        window.innerWidth,
        window.innerHeight,
        {
          depthTexture: depthTexture,
          depthBuffer: true,
        }
      );

      const fov = 80;
      const aspect = 2;  // the canvas default
      const near = 1;
      const far = 7000;
      const camera = new _3js.PerspectiveCamera(fov, aspect, near, far);
      // const camera = new _3js.OrthographicCamera(-1900, 1900, 1450, -1450, 1, 7000);
      camera.position.set(750,-1500,500);
      camera.up = new _3js.Vector3(0,0,1);
      camera.lookAt(new _3js.Vector3(750,450,500));
      // console.log(camera.target);

      var scene = new _3js.Scene();
      scene.background = new _3js.Color("#ffffff");
      // scene.rotation.x = -90*Math.PI/180;

      // Initial render pass.
      const composer = new EffectComposer(renderer, renderTarget);
      const pass = new RenderPass(scene, camera);
      composer.addPass(pass);

      var control = new Control( camera, composer );

      // // Outline pass.
      // const customOutline = new CustomOutlinePass(
      //   new _3js.Vector2(window.innerWidth, window.innerHeight),
      //   scene,
      //   camera
      // );
      // composer.addPass(customOutline);
      // // Antialias pass.
      // const effectFXAA = new ShaderPass(FXAAShader);
      // effectFXAA.uniforms["resolution"].value.set(
      //   1 / window.innerWidth,
      //   1 / window.innerHeight
      // );
      // composer.addPass(effectFXAA);

      // shaper.setScene(scene);
      shaper0.setScene(scene);

      var materials = {
        stucco:     {f: {color: 0xfcd690, opacity: .5}, b: {color: 0xffaabb, opacity: .5}},
        cornice:    {f: {color: 0xfffdf2, opacity: 1}, b: {color: 0xff00ff, opacity: 1}},
        // plaster:  {f: {color: 0xc3c3c3, opacity: 0.5, blending: _3js.NormalBlending}, b: {color: 0xffff00, opacity: 0.5, blending: _3js.NormalBlending}},
        plaster:    {f: {color: 0xd3d3d3, opacity: 1}, b: {color: 0xffff00, opacity: 1}},
        ceiling:      {f: {color: 0xc3c3c3, opacity: .1}, b: {color: 0xffff00, opacity: .1}},
        floor:      {f: {color: 0xb58148, opacity: .1}, b: {color: 0x5555ff, opacity: .1}},
        stone:      {f: {color: 0xababab, opacity: 1}, b: {color: 0xababab, opacity: 1}},
        terracotta: {f: {color: 0xe2725b, opacity: .5}, b: {color: 0xe2725b, opacity: .5}},
        debug:      {f: {color: 0xff0000, opacity: 0.5}, b: {color: 0x0000ff, opacity: 0.5}}
      };

      // var crap = new doug.Surface("crap").setSize({dw: 0, h: 0}).setBevel({y: 5, miters:{angle:{left:-45, right:0}}}).setOffset({dx: 0});
      // console.log(crap);

      function cornice(wallSystem, delta, angle) {
        wallSystem
          .setExteriorMaterial(materials.cornice)
          .addExteriorSurface(new doug.Surface("cornice1H").setOn(wallSystem.surfaces.main).setSize({dw: delta.dw, h: 0}).setBevel({y: 5, miters:angle}).setOffset({dx: delta.dx}))
          .addExteriorSurface(new doug.Surface("cornice1V").setOn(wallSystem.surfaces.cornice1H).setSize({h: 8}))
          .addExteriorSurface(new doug.Surface("cornice2H").setOn(wallSystem.surfaces.cornice1V).setSize({h: 0}).setBevel({y: 5, miters:angle}))
          .addExteriorSurface(new doug.Surface("cornice2V").setOn(wallSystem.surfaces.cornice2H).setSize({h: 18}))
          .addExteriorSurface(new doug.Surface("cornice3B").setOn(wallSystem.surfaces.cornice2V).setSize({h: 5}).setBevel({y: 5, miters:angle}))
          .addExteriorSurface(new doug.Surface("cornice4H").setOn(wallSystem.surfaces.cornice3B).setSize({h: 0}).setBevel({y: 5, miters:angle}))
          .addExteriorSurface(new doug.Surface("cornice4V").setOn(wallSystem.surfaces.cornice4H).setSize({h: 6}))
          .addExteriorSurface(new doug.Surface("cornice5B").setOn(wallSystem.surfaces.cornice4V).setSize({h: 6}).setBevel({y: 8, miters:angle}))
          .addExteriorSurface(new doug.Surface("cornice5V").setOn(wallSystem.surfaces.cornice5B).setSize({h: 6}))
          .addExteriorSurface(new doug.Surface("cornice6H").setOn(wallSystem.surfaces.cornice5V).setSize({h: 0}).setBevel({y: 40, miters:angle}))
          .addExteriorSurface(new doug.Surface("cornice6V").setOn(wallSystem.surfaces.cornice6H).setSize({h: 18}))
          .addExteriorSurface(new doug.Surface("cornice7H").setOn(wallSystem.surfaces.cornice6V).setSize({h: 0}).setBevel({y: -68, miters:angle}).flip())
        ;
      }

      var ground = 0;
      var corniceH = 8+18+5+6+6+6+18;
      var level0Z = ground;
      var level0H = 278;
      var level0CeilingThickness = 40;
      var level1Z = 289; //level0Z+level0H+level0CeilingThickness;
      var level1H = 342;
      var level1CeilingThickness = 20;
      var level2Z = level1Z + level1H+level1CeilingThickness;
      var level2H = 337;
      var level2CeilingThickness = 20;
      var totalH = level2Z+level2H+level2CeilingThickness;

      class bigWindow extends doug.Window {size = {w: 200, h: 100};};
      class smallWindow extends doug.Window {size = {w: 100, h: 50};};
      class Window90x190 extends doug.Window {size = {w: 90, h: 190};};
      class Door90x275 extends doug.Window {size = {w: 90, h: 275};};
      class Door95x205 extends doug.Window {size = {w: 95, h: 205};};
      class Window90x185 extends doug.Window {size = {w: 90, h: 185};};

      class Floor extends doug.Surface {color = materials.floor};
      class Ceiling extends doug.Surface {color = materials.ceiling};

      var thick = {
        east: {L0: 70, L1: 70, L2: 70},
        south: {L0: 85, L1: 80, L2: 75},
        west: {L0: 60, L1: 60, L2: 60},
        north: {L0: 65, L1: 65, L2: 65},
      };
      var rooms = {
        L0: {
          cellar1: {z: -88, h: 320, w: 488, y: 750},
          cellar2front: {z: -28, h: 278, w: 459, y: 414-50}
        },
        L1: {
          living: {z: 289, h: 342, w: 536, y: 510},
          entry: {z: 282, h: 337, w: 223, y: 222}
        },
        L2: {
          bedroom: {z: 651, h: 337, w: 545, y: 460},
          bedroom1: {x: 545, y: 459, h: 337},
          bathroom1: {x: 372+17+26+113+22, y: 330, h: 335},
          bedroom2: {x: 492, y: 429, h: 341},
          bathroom2: {x: 438-231-71+17+305, y: 251+10, h: 341},
          landing: {x: 231, y: 552-213-10+200+12, h: 350},
        },
        L3: {
          landing: {x: 222, y: 213, h: 190},
        }
      };

      function roomWallSize(parameters) {
        switch (parameters.side) {
          case "east":
          case "west":
            return {w: rooms[parameters.level][parameters.room].w, h: rooms[parameters.level][parameters.room].h};
          case "north":
          case "south":
            return {w: rooms[parameters.level][parameters.room].y, h: rooms[parameters.level][parameters.room].h};
        }
      }
      function roomWallOffset(parameters, offset) {
        if (!offset) {offset = {x: 0, y: 0, z: 0};}
        switch (parameters.sides.y) {
          case "east":
          return _.mergeWith(offset,
            // {x: thick[parameters.sides.x][parameters.level], y: -thick[parameters.sides.y][parameters.level], z: rooms[parameters.level][parameters.room].z},
            {x: thick[parameters.sides.x][parameters.level], y: thick[parameters.sides.y][parameters.level], z: rooms[parameters.level][parameters.room].z},
            function(result, value) {return result + value;}
          );
          case "south":
          return _.mergeWith(offset,
            // {x: -thick[parameters.sides.x][parameters.level], y: -thick[parameters.sides.y][parameters.level], z: rooms[parameters.level][parameters.room].z},
            {x: thick[parameters.sides.y][parameters.level], y: thick[parameters.sides.x][parameters.level], z: rooms[parameters.level][parameters.room].z},
            function(result, value) {return result + value;}
          );
        }
      }
      // console.log(roomWallSize({level: "L0", room: "cellar", side: "east"}));
      // console.log(roomWallOffset({level: "L0", room: "cellar", side: "east"}, {x: 100, y: 0, z: 0}));

      function planeSet(d) {
        return {
          north: new doug.Plane("North+X").setFacingDirection([1,0,0]).setOriginOffset([d.offset.x + d.size.x, d.offset.y, d.offset.z]),
          south: new doug.Plane("South-X").setFacingDirection([-1,0,0]).setOriginOffset([d.offset.x, d.offset.y, d.offset.z]),
          east: new doug.Plane("East-Y").setFacingDirection([0,-1,0]).setOriginOffset([d.offset.x, d.offset.y, d.offset.z]),
          west: new doug.Plane("West+Y").setFacingDirection([0,1,0]).setOriginOffset([d.offset.x, d.offset.y + d.size.y, d.offset.z])
        };
      }

      // var wallH = 1033;
      var wallH = 1076 - corniceH;
      var eastWallWidth = 1500;
      var southWallWidth = 942;
      var angle = 5;
      var westWallWidth = eastWallWidth/Math.cos(angle*Math.PI/180);
      var northWallWidth = southWallWidth - westWallWidth*Math.sin(angle*Math.PI/180);
      var living2WestWallWidth = 536/Math.cos(angle*Math.PI/180);
      var living2NorthWallWidth = 244+15 - living2WestWallWidth*Math.sin(angle*Math.PI/180);
      var bathroom1L2WestWallWidth = rooms.L2.bathroom1.x/Math.cos(angle*Math.PI/180);
      var bathroom1L2NorthWallWidth = rooms.L2.bathroom1.y - bathroom1L2WestWallWidth*Math.sin(angle*Math.PI/180);
      var bathroom2L2WestWallWidth = rooms.L2.bathroom2.x/Math.cos(angle*Math.PI/180);
      var bathroom2L2NorthWallWidth = rooms.L2.bathroom2.y - bathroom2L2WestWallWidth*Math.sin(angle*Math.PI/180);
      var landingL2WestWallWidth = rooms.L2.landing.x/Math.cos(angle*Math.PI/180);
      var landingL2NorthWallWidth = rooms.L2.landing.y - landingL2WestWallWidth*Math.sin(angle*Math.PI/180);
      var entryL1WestWallWidth = rooms.L1.entry.w/Math.cos(angle*Math.PI/180);
      var entryL1NorthWallWidth = rooms.L1.entry.y - entryL1WestWallWidth*Math.sin(angle*Math.PI/180);

      var planes = {
        exteriors: {
          north: new doug.Plane("North+X").setFacingDirection([1,0,0]).setOriginOffset([eastWallWidth,0,0]),
          south: new doug.Plane("South-X").setFacingDirection([-1,0,0]),
          east: new doug.Plane("East-Y").setFacingDirection([0,-1,0]),
          west: new doug.Plane("West+Y").setFacingDirection([0,1,0]).setOriginOffset([0,southWallWidth,0]).setRotationZ(-5),
          kitchen: {
            north: new doug.Plane("North+X").setFacingDirection([1,0,0]).setOriginOffset([604, southWallWidth-604*Math.tan(angle*Math.PI/180), ground+1076-790]),
            south: new doug.Plane("South-X").setFacingDirection([-1,0,0]).setOriginOffset([0, southWallWidth, ground+1076-790]),
            west: new doug.Plane("West+Y").setFacingDirection([0,1,0]).setOriginOffset([0, southWallWidth+416, ground+1076-790]).setRotationZ(-5)
          }
        },
        levels: {
          ground: {
            rooms: {
              cellar1: planeSet({size: {x: rooms.L0.cellar1.w, y: rooms.L0.cellar1.y}, offset: {x: 85, y: 75, z: rooms.L0.cellar1.z}}),
              cellar2front: planeSet({size: {x: 459, y: 414-50}, offset: {x: 85+488+65+115+108+60, y: 75, z: -28}}),
              cellar2back: planeSet({size: {x: 459-45-10, y: 245}, offset: {x: 85+488+65+115+108+60, y: 75+414-50+20, z: -55}}),
              hall: planeSet({size: {x: 115+108, y: 487}, offset: {x: 85+488+60, y: 65, z: 0}}),
              cellar3: planeSet({size: {x: 241, y: 205}, offset: {x: 85+488+60-10, y: 65+487+20, z: -41}}),
            },
            perimeter: {
              north: new doug.Plane("North+X").setFacingDirection([1,0,0]).setOriginOffset([1500,-1143,0]),
              south: new doug.Plane("South-X").setFacingDirection([-1,0,0]).setOriginOffset([-1032,-1143,0]),
              east: new doug.Plane("East-Y").setFacingDirection([0,-1,0]).setOriginOffset([-1032,-1143,0]),
              west: new doug.Plane("West+Y").setFacingDirection([0,1,0]).setOriginOffset([-1032,2741-1143,0])
            }
          },
          first: {
            rooms: {
              living: planeSet({size: {x: 536, y: 510}, offset: {x: 70, y: 70, z: 282}}),
              living2: planeSet({size: {x: 536, y: 244+15}, offset: {x: 70, y: 70+510+17, z: 282}}),
              bedroom: planeSet({size: {x: 493, y: 450}, offset: {x: 70+536+30+223+60, y: 70, z: 282}}),
              bedroom2: planeSet({size: {x: 455, y: 202}, offset: {x: 901, y: 70+450+20, z: 282}}),
              landing: planeSet({size: {x: 220, y: 202}, offset: {x: 70+rooms.L1.living.w+30, y: 70, z: 464}}),
              entry: planeSet({size: {x: rooms.L1.entry.w, y: rooms.L1.entry.y}, offset: {x: 70+536+30, y: 70+510, z: rooms.L1.entry.z}}),
              kitchen: {
                north: new doug.Plane("North+X").setFacingDirection([1,0,0]).setOriginOffset([604-16, southWallWidth-(604-16)*Math.tan(angle*Math.PI/180), ground+1076-790]),
                south: new doug.Plane("South-X").setFacingDirection([-1,0,0]).setOriginOffset([0+16, southWallWidth-(0+16)*Math.tan(angle*Math.PI/180), ground+1076-790]),
                east: new doug.Plane("East-Y").setFacingDirection([0,-1,0]).setOriginOffset([16, southWallWidth, ground+1076-790]).setRotationZ(-5),
                west: new doug.Plane("West+Y").setFacingDirection([0,1,0]).setOriginOffset([0+16, southWallWidth+416-16, ground+1076-790]).setRotationZ(-5)
              }
            }
          },
          second: {
            rooms: {
              bedroom1: planeSet({size: {x: rooms.L2.bedroom1.x, y: rooms.L2.bedroom1.y}, offset: {x: 70, y: 70, z: 650}}),
              bathroom1: planeSet({size: {x: rooms.L2.bathroom1.x, y: rooms.L2.bathroom1.y}, offset: {x: 70, y: 70+rooms.L2.bedroom1.y+17, z: 650}}),
              bedroom2: planeSet({size: {x: rooms.L2.bedroom2.x, y: rooms.L2.bedroom2.y}, offset: {x: 70+rooms.L2.bedroom1.x+30+222+60, y: 70, z: 650}}),
              bathroom2: planeSet({size: {x: rooms.L2.bathroom2.x, y: rooms.L2.bathroom2.y}, offset: {x: 70+rooms.L2.bedroom1.x+30+222+60, y: 70+rooms.L2.bedroom2.y+17, z: 650}}),
              landing: planeSet({size: {x: rooms.L2.landing.x, y: rooms.L2.landing.y}, offset: {x: 70+rooms.L2.bedroom1.x+30, y: 75+213+10, z: 650}}),
            }
          },
          third: {
            rooms: {
              landing: planeSet({size: {x: rooms.L3.landing.x, y: rooms.L3.landing.y}, offset: {x: 70+rooms.L2.bedroom1.x+21, y: 75, z: 800}}),
            }
          }
        }
      };

      planes.levels.first.rooms.living2.west.setRotationZ(-5);
      // planes.levels.first.rooms.bedroom2.south.setRotationZ(-5);
      planes.levels.first.rooms.bedroom2.west.setRotationZ(-5);
      planes.levels.first.rooms.entry.west.setRotationZ(-5);
      planes.levels.second.rooms.bathroom1.west.setRotationZ(-5);
      planes.levels.second.rooms.bathroom2.west.setRotationZ(-5);
      planes.levels.second.rooms.landing.west.setRotationZ(-5);
      // planes.levels.first.rooms.living2 =
      // planes.L1 = {bedroom: {
      //   north: new doug.Plane("North+X").setFacingDirection([1,0,0]).setOriginOffset([901+493, 70, 289]),
      //   south: new doug.Plane("South-X").setFacingDirection([-1,0,0]).setOriginOffset([901,70,289]),
      //   east: new doug.Plane("East-Y").setFacingDirection([0,-1,0]).setOriginOffset([901,70,289]),
      //   west: new doug.Plane("West+Y").setFacingDirection([0,1,0]).setOriginOffset([901, 70+450, 289])
      // }};

      var eastWall = new doug.WallSystem("East Wall")
        // .hide()
        .setPlane(planes.exteriors.east)
        .setExteriorMaterial(materials.stucco)
        .addExteriorSurface(new doug.Surface("main").setPlane(planes.exteriors.east)
          .setSize({w: eastWallWidth, h: wallH})
          .setOffset({x: 0, y: 0, z: ground})
          .setWindows(new doug.Windows([
            "cellar1", "cellar2", "cellar3", "cellar4", "cellar5",
            "leftL1LR", "rightL1LR", "stairL1", "leftL1BR", "rightL1BR",
            "leftL2LR", "rightL2LR", "stairL2", "leftL2BR", "rightL2BR"
          ]))
        )
        .addWindow(new doug.Window("cellar1").setOffset({x: 172, z: 150}).setSize({w: 70, h: 60}))
        .addWindow(new doug.Window("cellar2").setOffset({dx: 210, z: 150, window: "cellar1"}).setSize({w: 60, h: 60}))
        .addWindow(new doug.Window("cellar3").setOffset({x: 703, z: 10}).setSize({w: 113, h: 224}))
        .addWindow(new doug.Window("cellar4").setOffset({dx: 210, z: 153, window: "cellar3"}).setSize({w: 40, h: 50}))
        .addWindow(new doug.Window("cellar5").setOffset({dx: 195, z: 10, window: "cellar4"}).setSize({w: 75, h: 193}))
        .addWindow(new Window90x185("leftL1LR").setOffset({x: 165, z: 373}))
        .addWindow(new Door90x275("rightL1LR").setOffset({dx: 165, z: 290, window: "leftL1LR"}))
        .addWindow(new Window90x190("stairL1").setOffset({dx: 186, z: 373, window: "rightL1LR"}))
        .addWindow(new Door90x275("leftL1BR").setOffset({dx: 186, z: 290, window: "stairL1"}))
        .addWindow(new Window90x190("rightL1BR").setOffset({dx: 165, z: 373, window: "leftL1BR"}))
        .addWindow(new Window90x190("leftL2LR").setOffset({x: 165, z: 750}))
        .addWindow(new Window90x190("rightL2LR").setOffset({dx: 165, z: 750, window: "leftL2LR"}))
        .addWindow(new Window90x190("stairL2").setOffset({dx: 186, z: 750, window: "rightL2LR"}))
        .addWindow(new Window90x190("leftL2BR").setOffset({dx: 186, z: 750, window: "stairL2"}))
        .addWindow(new Window90x190("rightL2BR").setOffset({dx: 165, z: 750, window: "leftL2BR"}))
        .call(cornice, {dw: 0, dx: 0}, {angle:{left:-45, right:0}})
        .call(shaper0.wallSystem)
      ;
      eastWall
        .setExteriorMaterial(materials.terracotta)
        .addExteriorSurface(new doug.Surface("roof")
          .setOn(eastWall.surfaces.cornice7H)
          .setSize({dw: 68-10, h: 472.5-10})
          .setBevel({y: 166.25, miters:{points:{middle:1091.5, right:0}}})
          .setOffset({dx: -68+10, dy: -68+10})
          .setRotation({x: -90, y: 0, z: 0})
        )
        // .call(shaper0.wallSystem)
      ;

      var southWall = new doug.WallSystem("South Wall")
        // .hide()
        .setPlane(planes.exteriors.south)
        .addWindow(new Window90x185("w1").setOffset({y: 165, z: 385}))
        .addWindow(new doug.Window("w2").setSize({w: 90, h:183}).setOffset({y: 80+510+50+17+20, z: 385}))
        .addWindow(new Window90x185("w3").setOffset({y: 165, z: 750}))
        .addWindow(new Window90x185("w4").setOffset({y: 660, z: 750}))
        .addWindow(new doug.Window("Kitchen1").setOffset({y: -350, z: 100}).setSize({w: 30, h:30}))
        .addWindow(new doug.Window("Kitchen2").setOffset({y: 293, z: 384}).setSize({w: 90, h:135}))
        .setExteriorMaterial(materials.stucco)
        .addExteriorSurface(new doug.Surface("main").setPlane(planes.exteriors.south)
          .setSize({w: southWallWidth, h: wallH})
          .setOffset({x: 0, y: 0, z: ground})
          .setWindows(new doug.Windows(["w1", "w2", "w3", "w4"]))
        )
        .call(cornice, {dw: 0, dx: 0}, {angle:{left:-45, right:45+5/2}})
        .call(shaper0.wallSystem)
      ;
      southWall
        .setExteriorMaterial(materials.terracotta)
        .addExteriorSurface(new doug.Surface("roof")
          .setOn(southWall.surfaces.cornice7H)
          .setSize({dw: 2*(68-10)+5.5, h: 479.15-10})
          .setBevel({y: 166.25, miters:{points:{middle: 0, left: 472.5-10}}})
          .setOffset({dx: -68+10, dy: -68+10})
          .setRotation({x: 0, y: 90, z: 0})
        )
        // .call(shaper0.wallSystem)
      ;

      var westWall = new doug.WallSystem("West Wall")
        // .hide()
        .addWindow(new doug.Window("door").setOffset({x: 733, z: 272+2.5}).setSize({w: 110, h: 215}))
        .addWindow(new doug.Window("door2").setOffset({x: 901+20, z: 272}).setSize({w: 120, h: 200}))
        .addWindow(new doug.Window("w1").setOffset({x: 733, z: 730}).setSize({w: 90, h: 125}))
        .addWindow(new doug.Window("w2").setOffset({x: 733+430, z: 730}).setSize({w: 90, h: 125}))
        .addWindow(new doug.Window("kitchen").setOffset({x: 0, z: 1076-790}).setSize({w: 604/Math.cos(angle*Math.PI/180), h: 356}))
        .setExteriorMaterial(materials.stucco)
        .addExteriorSurface(new doug.Surface("main").setPlane(planes.exteriors.west)
          .setSize({w: westWallWidth, h: wallH})
          .setOffset({x: 0, y:0 , z: ground})
          .setWindows(new doug.Windows(["door", "w1", "w2", "door2", "kitchen"]))
        )
        .call(cornice, {dw: 65-westWallWidth, dx: 0}, {angle:{left:-45-5/2, right:0}})
        .call(shaper0.wallSystem);
      ;
      // westWall
      //   .setExteriorMaterial(materials.terracotta)
      //   .addExteriorSurface(new doug.Surface("roof")
      //     .setOn(westWall.surfaces.cornice7H)
      //     .addPointInSpace({x: -(68-10+5.5), y: -(68-10)})
      //     .addPointInSpace({x: 500, y: -560})
      //     .addPointInSpace({x: 1530, y: -530})
      //     .addPointInSpace({x: westWallWidth, y: -(68-10)})
      //     .setBevel({y: 166.25, points: [[0,0], [500,-300], [930, -200], [900, 0]]})
      //     // .setSize({dw: westWallWidth - 65 + 2*(68-10)+5.5, h: 560.75-10})
      //     // .setBevel({y: 166.25, miters:{points:{middle: 1091.5, left: 472.5-10}}})
      //     // .setOffset({dx: -(68-10+5.5), dy: 68-10})
      //     // .setRotation({x: 90, y: 0, z: 0})
      //   )
      //   .call(shaper0.wallSystem)
      // ;
      // console.log(westWall.surfaces);
      // var plane = new _3js.Plane().setFromCoplanarPoints(new _3js.Vector3(500,-560,166.25), new _3js.Vector3(1530,-530,166.25), new _3js.Vector3(westWallWidth,0,0));//Effect
      // var plane = shaper0.test();
      // // console.log(plane);
      // // console.log(westWallWidth);
      // var planehelper = new _3js.PlaneHelper( plane, 1000, 0xff0000 );
      // scene.add(planehelper);
      //

      var northWall = new doug.WallSystem("North Wall")
        // .hide()
        .setPlane(planes.exteriors.north)
        .setExteriorMaterial(materials.stucco)
        .addExteriorSurface(new doug.Surface("main")
          .setSize({w: northWallWidth, h: wallH})
          .setOffset({x: 0, y:0 , z: ground})
        )
        .call(shaper0.wallSystem);
      ;

      var southKitchenWall = new doug.WallSystem("South Kitchen Wall")
        .setPlane(planes.exteriors.kitchen.south)
        .addWindow(new doug.Window("w1").setOffset({y: 16, z: 385-(ground+1076-790)}).setSize({w: 65, h: 140}))
        .addWindow(new doug.Window("w2").setOffset({y: 416-(16+54+27), z: 385-(ground+1076-790)+70}).setSize({w: 27, h: 27}))
        .setExteriorMaterial(materials.stucco)
        .addExteriorSurface(new doug.Surface("main")
          .setSize({w: 416, h: 356})
          .setWindows(new doug.Windows(["w1", "w2"]))
        )
        .call(shaper0.wallSystem);
      ;
      var westKitchenWall = new doug.WallSystem("West Kitchen Wall")
        .setPlane(planes.exteriors.kitchen.west)
        .addWindow(new doug.Window("w1").setOffset({x: 483-90, z: 96}).setSize({w: 90, h: 160}))
        .setExteriorMaterial(materials.stucco)
        .addExteriorSurface(new doug.Surface("main")
          .setSize({w: 604/Math.cos(angle*Math.PI/180), h: 356})
          .setWindows(new doug.Windows(["w1"]))
        )
        .call(shaper0.wallSystem);
      ;
      var northKitchenWall = new doug.WallSystem("North Kitchen Wall")
        .setPlane(planes.exteriors.kitchen.north)
        .setExteriorMaterial(materials.stucco)
        .addExteriorSurface(new doug.Surface("main")
          .setSize({w: 416, h: 356})
        )
        .call(shaper0.wallSystem);
      ;

      // var xxx = new doug.RectangularRoom("living")
      //   .setOffset({x: 80, y: 70, z: 282})
      //   .width(536).depth(510).height(342)
      //   .getWall("east")
      //     .addWindow(eastWall.getWindow("leftL1LR"))
      //     .addWindow(eastWall.getWindow("rightL1LR"))
      //   .getWall("south")
      //     .addWindow(southWall.getWindow("w1"))
      //   .getWall("west")
      //     .addDoor(new doug.Door().width(95).height(205).offsetWidth(414))
      //   .getRoom();
      // ;
      // var shit = {l1: {living: new doug.RectangularRoom("living")}};
      // shit.l1.living
      //   .setOffset({x: 80, y: 70, z: 282})
      //   .width(536).depth(510).height(342)
      //   .getWall("east")
      //     .addWindow(eastWall.getWindow("leftL1LR"))
      //     .addWindow(eastWall.getWindow("rightL1LR"))
      //   .getWall("south")
      //     .addWindow(southWall.getWindow("w1"))
      //   .getWall("west")
      //     .addDoor(new doug.Door().width(95).height(205).offsetWidth(414))
      // ;
      // console.log(shit);

      var crap = {
        levels: {
          ground: {},
          first: {},
          second: {}
        }
      };
      crap.levels.first.living1 = new doug.WallSystem("Living L1")
        .setInteriorMaterial(materials.plaster)
        .addWindow(new doug.Window("door").setSize({w: 95, h: 205}).setOffset({x: 414, z: 0}))
        .addInteriorSurface(new doug.Surface("east").setPlane(planes.levels.first.rooms.living.east)
          .setSize({w: 536, h: 342})
          .setWindows(new doug.Windows(["leftL1LR", "rightL1LR"]).setWall(eastWall.surfaces.main).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("south").setPlane(planes.levels.first.rooms.living.south)
          .setSize({w: 510, h: 342})
          .setWindows(new doug.Windows(["w1"]).setWall(southWall.surfaces.main).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("west").setPlane(planes.levels.first.rooms.living.west)
          .setSize({w: 536, h: 342})
          .setWindows(new doug.Windows(["door"]))
        )
        .addInteriorSurface(new doug.Surface("north").setPlane(planes.levels.first.rooms.living.north)
          .setSize({w: 510, h: 342})
        )
      ;

      crap.levels.first.living2 = new doug.WallSystem("Living2 L1")
        .setInteriorMaterial(materials.plaster)
        .addWindow(new doug.Window("entry").setSize({w: 139, h: 205}).setOffset({y: 37, z: 0}))
        .addWindow(new doug.Window("kit1").setSize({w: 80, h: 190}).setOffset({x: 536-61-80, z: 0}))
        .addWindow(new doug.Window("kit2").setSize({w: 91, h: 190}).setOffset({x: 0, z: 0}))
        .addInteriorSurface(new doug.Surface("eastb").setPlane(planes.levels.first.rooms.living2.east)
          .setSize({w: 536, h: 348})
          .setWindows(new doug.Windows(["door"]).setWall(crap.levels.first.living1.surfaces.west).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("south").setPlane(planes.levels.first.rooms.living2.south)
          .setSize({w: 244+15, h: 348})
          .setWindows(new doug.Windows(["w2"]).setWall(southWall.surfaces.main).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("west").setPlane(planes.levels.first.rooms.living2.west)
          .setSize({w: living2WestWallWidth, h: 348})
          .setWindows(new doug.Windows(["kit1", "kit2"]))
        )
        .addInteriorSurface(new doug.Surface("north").setPlane(planes.levels.first.rooms.living2.north)
          .setSize({w: living2NorthWallWidth, h: 348})
          .setWindows(new doug.Windows(["entry"]))
        )
      ;

      crap.levels.first.bedroom = new doug.WallSystem("Bedroom L1")
        .setPlane(planes.levels.first.rooms.bedroom.east)
        .setInteriorMaterial(materials.plaster)
        .addWindow(new Door95x205("door").setOffset({x: 40, z: 0}))
        .addWindow(new doug.Window("closet").setSize({w: 97, h: 205}).setOffset({y: 279, z: 0}))
        .addWindow(new doug.Window("nookie").setSize({w: 137, h: 205}).setOffset({y: 10, z: 0}))
        .addInteriorSurface(new doug.Surface("east").setPlane(planes.levels.first.rooms.bedroom.east)
          .setSize({w: 493, h: 329})
          .setWindows(new doug.Windows(["leftL1BR", "rightL1BR"]).setWall(eastWall.surfaces.main).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("south").setPlane(planes.levels.first.rooms.bedroom.south)
          .setSize({w: 450, h: 329})
          .setWindows(new doug.Windows(["closet"]))
        )
        .addInteriorSurface(new doug.Surface("south nook 1").setPlane(planes.levels.first.rooms.bedroom.south)
          .setSize({w: 35, h: 205})
          .setOffset({x: 0, y: 279, z: 0})
          .setRotation({x: 0, y: 0, z: 90})
        )
        .addInteriorSurface(new doug.Surface("south nook 2").setPlane(planes.levels.first.rooms.bedroom.south)
          .setSize({w: 97, h: 205})
          .setOffset({x: -35, y: 279, z: 0})
          .setRotation({x: 0, y: 0, z: 0})
        )
        .addInteriorSurface(new doug.Surface("south nook 3").setPlane(planes.levels.first.rooms.bedroom.south)
          .setSize({w: 35, h: 205})
          .setOffset({x: 0, y: 279+97, z: 0})
          .setRotation({x: 0, y: 0, z: 90})
          .flip()
        )
        .addInteriorSurface(new doug.Surface("west").setPlane(planes.levels.first.rooms.bedroom.west)
          .setSize({w: 501, h: 329})
          .setWindows(new doug.Windows(["door"]))
        )
        .addInteriorSurface(new doug.Surface("north").setPlane(planes.levels.first.rooms.bedroom.north)
          .setSize({w: 447, h: 329})
          .setWindows(new doug.Windows(["nookie"]))
        )
        .addInteriorSurface(new doug.Surface("north nook 1").setPlane(planes.levels.first.rooms.bedroom.north)
          .setSize({w: 65, h: 205})
          .setOffset({x: 0, y: 10, z: 0})
          .setRotation({x: 0, y: 0, z: -90})
        )
        .addInteriorSurface(new doug.Surface("north nook 2").setPlane(planes.levels.first.rooms.bedroom.north)
          .setSize({w: 137-65/Math.tan(Math.PI/3), h: 205})
          .setOffset({x: 65, y: 10, z: 0})
          .setRotation({x: 0, y: 0, z: 0})
        )
        .addInteriorSurface(new doug.Surface("north nook 3").setPlane(planes.levels.first.rooms.bedroom.north)
          .setSize({w: 65/Math.sin(Math.PI/3), h: 205})
          .setOffset({x: 65, y: 10+137-65/Math.tan(Math.PI/3), z: 0})
          .setRotation({x: 0, y: 0, z: 60})
        )
      ;

      crap.levels.first.bathroom = new doug.WallSystem("Bedroom2L1")
        .setInteriorMaterial(materials.plaster)
        .addWindow(new doug.Window("entry").setSize({w: 142, h: 320}).setOffset({y: 201-142, z: 0}))
        .addInteriorSurface(new doug.Surface("east").setPlane(planes.levels.first.rooms.bedroom2.east)
          .setSize({w: 455, h: 333})
          .setWindows(new doug.Windows(["door"]).setWall(crap.levels.first.bedroom.surfaces.west).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("south").setPlane(planes.levels.first.rooms.bedroom2.south)
          .setSize({w: 202, h: 333})
          .setWindows(new doug.Windows(["entry"]))
        )
        .addInteriorSurface(new doug.Surface("west").setPlane(planes.levels.first.rooms.bedroom2.west)
          .setSize({w: 455/Math.cos(5*Math.PI/180), h: 333})
          .setWindows(new doug.Windows(["door2"]).setWall(westWall.surfaces.main).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("north").setPlane(planes.levels.first.rooms.bedroom2.north)
          .setSize({w: 202-455*Math.tan(5*Math.PI/180), h: 333})
        )
      ;
      // console.log(455/Math.cos(5*Math.PI/180));

      crap.levels.first.entry = new doug.WallSystem("Entry")
        .setInteriorMaterial(materials.plaster)
        .addWindow(new doug.Window("stairL0").setSize({w: 100, h: 250}).setOffset({x: 123, z: 0}))
        .addWindow(new doug.Window("stairL2").setSize({w: 100, h: 272}).setOffset({x: 0, z: 0}))
        .addInteriorSurface(new doug.Surface("east").setPlane(planes.levels.first.rooms.entry.east)
          .setSize({w: rooms.L1.entry.w, h: rooms.L1.entry.h})
          .setWindows(new doug.Windows(["stairL0", "stairL2"]))
        )
        .addInteriorSurface(new doug.Surface("south").setPlane(planes.levels.first.rooms.entry.south)
          .setSize({w: rooms.L1.entry.y, h: rooms.L1.entry.h})
          .setWindows(new doug.Windows(["entry"]).setWall(crap.levels.first.living2.surfaces.north).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("west").setPlane(planes.levels.first.rooms.entry.west)
          .setSize({w: entryL1WestWallWidth, h: rooms.L1.entry.h})
          .setWindows(new doug.Windows(["door"]).setWall(westWall.surfaces.main).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("north").setPlane(planes.levels.first.rooms.entry.north)
          .setSize({w: entryL1NorthWallWidth, h: rooms.L1.entry.h})
          .setWindows(new doug.Windows(["entry"]).setWall(crap.levels.first.bathroom.surfaces.south).setJambsAll())
        )
      ;

      crap.levels.first.kitchen = new doug.WallSystem("Kitchen")
        .setInteriorMaterial(materials.plaster)
        .addInteriorSurface(new doug.Surface("east").setPlane(planes.levels.first.rooms.kitchen.east)
          .setSize({w: (604-16-16)/Math.cos(angle*Math.PI/180), h: 305})
          .setWindows(new doug.Windows(["kit1", "kit2"]).setWall(crap.levels.first.living2.surfaces.west).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("south").setPlane(planes.levels.first.rooms.kitchen.south)
          .setSize({w: 406, h: 305})
          .setWindows(new doug.Windows(["w1", "w2"]).setWall(southKitchenWall.surfaces.main).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("west").setPlane(planes.levels.first.rooms.kitchen.west)
          .setSize({w: (604-16-16)/Math.cos(angle*Math.PI/180), h: 305})
          .setWindows(new doug.Windows(["w1"]).setWall(westKitchenWall.surfaces.main).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("north").setPlane(planes.levels.first.rooms.kitchen.north)
          .setSize({w: 406, h: 305})
        )
      ;

      crap.levels.first.landing = new doug.WallSystem("Landing")
        .setInteriorMaterial(materials.plaster)
        .addWindow(new doug.Window("stair").setSize({w: 220, h: 320}).setOffset({x: 0, z: 0}))
        .addInteriorSurface(new doug.Surface("east").setPlane(planes.levels.first.rooms.landing.east)
          .setSize({w: 220, h: 320})
          .setWindows(new doug.Windows(["stairL1", "stairL2"]).setWall(eastWall.surfaces.main).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("south").setPlane(planes.levels.first.rooms.landing.south)
          .setSize({w: 202, h: 320})
        )
        .addInteriorSurface(new doug.Surface("west").setPlane(planes.levels.first.rooms.landing.west)
          .setSize({w: 220, h: 320})
          .setWindows(new doug.Windows(["stair"]))
        )
        .addInteriorSurface(new doug.Surface("north").setPlane(planes.levels.first.rooms.landing.north)
          .setSize({w: 202, h: 320})
        )
      ;

      crap.levels.ground.cellar1 = new doug.WallSystem("cellar1 L0")
        .setInteriorMaterial(materials.plaster)
        .addWindow(new doug.Window("door").setSize({w: 116, h: 205}).setOffset({y: 20, z: -rooms.L0.cellar1.z}))
        .addInteriorSurface(new doug.Surface("east").setPlane(planes.levels.ground.rooms.cellar1.east)
          .setSize({w: rooms.L0.cellar1.w, h: rooms.L0.cellar1.h})
          .setWindows(new doug.Windows(["cellar1", "cellar2"]).setWall(eastWall.surfaces.main).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("south").setPlane(planes.levels.ground.rooms.cellar1.south)
          .setSize({w: rooms.L0.cellar1.y, h: rooms.L0.cellar1.h})
        )
        .addInteriorSurface(new doug.Surface("west").setPlane(planes.levels.ground.rooms.cellar1.west)
          .setSize({w: rooms.L0.cellar1.w, h: rooms.L0.cellar1.h})
        )
        .addInteriorSurface(new doug.Surface("north").setPlane(planes.levels.ground.rooms.cellar1.north)
          .setSize({w: rooms.L0.cellar1.y, h: rooms.L0.cellar1.h})
          .setWindows(new doug.Windows(["door"]))
        )
      ;
      // const lightBulb2 = new _3js.PointLight( 0xffffff, .5, 100, 2 );
      // // lightBulb2.position.set( rooms.L0.cellar1.w/2, rooms.L0.cellar1.y/2, 0.9*(rooms.L0.cellar1.h + rooms.L0.cellar1.z) );
      // lightBulb2.position.set( rooms.L0.cellar1.w/2, rooms.L0.cellar1.y/2, 100 );
      // scene.add( lightBulb2 );


      crap.levels.ground.cellar2front = new doug.WallSystem("cellar2front L0")
        .setPlane(planes.levels.ground.rooms.cellar2front.east)
        .setInteriorMaterial(materials.plaster)
        .addWindow(new doug.Window("door").setSize({w: 94, h: 191}).setOffset({x: 459-94-45, z: 0}))
        .addWindow(new doug.Window("window").setSize({w: 50, h: 60}).setOffset({x: 68, z: 160}))
        .addWindow(new doug.Window("nook").setSize({w: 102, h: 150}).setOffset({y: 0, z: 0}))
        .addInteriorSurface(new doug.Surface("east").setPlane(planes.levels.ground.rooms.cellar2front.east)
          .setSize({w: rooms.L0.cellar2front.w, h: rooms.L0.cellar2front.h})
          .setWindows(new doug.Windows(["cellar4", "cellar5"]).setWall(eastWall.surfaces.main).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("south").setPlane(planes.levels.ground.rooms.cellar2front.south)
          .setSize({w: rooms.L0.cellar2front.y, h: rooms.L0.cellar2front.h})
        )
        .addInteriorSurface(new doug.Surface("west").setPlane(planes.levels.ground.rooms.cellar2front.west)
          .setSize({w: rooms.L0.cellar2front.w, h: rooms.L0.cellar2front.h})
          .setWindows(new doug.Windows(["door", "window"]))
        )
        .addInteriorSurface(new doug.Surface("north").setPlane(planes.levels.ground.rooms.cellar2front.north)
          .setSize({w: rooms.L0.cellar2front.y, h: rooms.L0.cellar2front.h})
          .setWindows(new doug.Windows(["nook"]))
        )
      ;

      crap.levels.ground.cellar2back = new doug.WallSystem("cellar2 back L0")
        .setInteriorMaterial(materials.plaster)
        .addWindow(new doug.Window("nook").setSize({w: 118, h: 300}).setOffset({y: 0, z: 0}))
        .addInteriorSurface(new doug.Surface("east").setPlane(planes.levels.ground.rooms.cellar2back.east)
          .setSize({w: 459-45-10, h: 305})
          .setWindows(new doug.Windows(["door"]).setWall(crap.levels.ground.cellar2front.surfaces.west).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("south").setPlane(planes.levels.ground.rooms.cellar2back.south)
          .setSize({w: 245, h: 305})
        )
        .addInteriorSurface(new doug.Surface("west").setPlane(planes.levels.ground.rooms.cellar2back.west)
          .setSize({w: 459-45-10, h: 305})
        )
        .addInteriorSurface(new doug.Surface("north").setPlane(planes.levels.ground.rooms.cellar2back.north)
          .setSize({w: 245, h: 305})
          .setWindows(new doug.Windows(["nook"]))
        )
        .addInteriorSurface(new doug.Surface("nook1").setPlane(planes.levels.ground.rooms.cellar2back.north)
          .setSize({w: 45, h: 305})
          .setOffset({x: 10, y: 0, z: 0})
          .setRotation({x: 0, y: 0, z: -90})
        )
        .addInteriorSurface(new doug.Surface("nook2").setPlane(planes.levels.ground.rooms.cellar2back.north)
          .setSize({w: 118, h: 305})
          .setOffset({x: 45+10, y: 0, z: 0})
        )
        .addInteriorSurface(new doug.Surface("nook3").setPlane(planes.levels.ground.rooms.cellar2back.north)
          .setSize({w: 45+10, h: 305})
          .setOffset({x: 0, y: 118, z: 0})
          .setRotation({x: 0, y: 0, z: -90})
          .flip()
        )
        .addNiche(new doug.Niche()
          .setSize(w: 118, d: 55, h: 305)
          .getNorth().setSize(w: 45).setOffset(x: 10)
        )
      ;

      crap.levels.ground.hall = new doug.WallSystem("Hall L0")
        .setInteriorMaterial(materials.plaster)
        .addWindow(new doug.Window("door").setSize({w: 83, h: 205}).setOffset({x: 18, z: 0}))
        .addWindow(new doug.Window("stair").setSize({w: 115+108, h: 437-272}).setOffset({x: 0, z: 272}))
        .addInteriorSurface(new doug.Surface("east").setPlane(planes.levels.ground.rooms.hall.east)
          .setSize({w: 115+108, h: 437})
          .setWindows(new doug.Windows(["cellar3", "stairL1"]).setWall(eastWall.surfaces.main).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("south").setPlane(planes.levels.ground.rooms.hall.south)
          .setSize({w: 487, h: 437})
          .setWindows(new doug.Windows(["door"]).setWall(crap.levels.ground.cellar1.surfaces.north).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("west").setPlane(planes.levels.ground.rooms.hall.west)
          .setSize({w: 115+108, h: 437})
          .setWindows(new doug.Windows(["door", "stair"]))
        )
        .addInteriorSurface(new doug.Surface("north").setPlane(planes.levels.ground.rooms.hall.north)
          .setSize({w: 487, h: 437})
        )
      ;

      crap.levels.ground.cellar3 = new doug.WallSystem("cellar3 L0")
        .setInteriorMaterial(materials.plaster)
        .addInteriorSurface(new doug.Surface("east").setPlane(planes.levels.ground.rooms.cellar3.east)
          .setSize({w: 241, h: 288})
          .setWindows(new doug.Windows(["door"]).setWall(crap.levels.ground.hall.surfaces.west).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("south").setPlane(planes.levels.ground.rooms.cellar3.south)
          .setSize({w: 205, h: 288})
        )
        .addInteriorSurface(new doug.Surface("west").setPlane(planes.levels.ground.rooms.cellar3.west)
          .setSize({w: 241, h: 288})
        )
        .addInteriorSurface(new doug.Surface("north").setPlane(planes.levels.ground.rooms.cellar3.north)
          .setSize({w: 205, h: 288})
        )
      ;

      crap.levels.second.bedroom1 = new doug.WallSystem("bedroom1L2").setPlane(planes.levels.second.rooms.bedroom1.south)//Fix this
        .setInteriorMaterial(materials.plaster)
        .addWindow(new doug.Window("door").setSize({w: 92, h: 205}).setOffset({x: 410+10, z: 0}))
        .addInteriorSurface(new doug.Surface("east").setPlane(planes.levels.second.rooms.bedroom1.east)
          .setSize({w: rooms.L2.bedroom1.x, h: rooms.L2.bedroom1.h})
          .setWindows(new doug.Windows(["leftL2LR", "rightL2LR"]).setWall(eastWall.surfaces.main).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("south").setPlane(planes.levels.second.rooms.bedroom1.south)
          .setSize({w: rooms.L2.bedroom1.y, h: rooms.L2.bedroom1.h})
          .setWindows(new doug.Windows(["w3"]).setWall(southWall.surfaces.main).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("west").setPlane(planes.levels.second.rooms.bedroom1.west)
          .setSize({w: rooms.L2.bedroom1.x, h: rooms.L2.bedroom1.h})
          .setWindows(new doug.Windows(["door"]))
        )
        .addInteriorSurface(new doug.Surface("north").setPlane(planes.levels.second.rooms.bedroom1.north)
          .setSize({w: rooms.L2.bedroom1.y, h: rooms.L2.bedroom1.h})
        )
      ;

      crap.levels.second.bathroom1 = new doug.WallSystem("bathroom1L2")
        .setInteriorMaterial(materials.plaster)
        .addWindow(new doug.Window("door").setSize({w: 200, h: 205}).setOffset({y: 59, z: 0}))
        .addInteriorSurface(new doug.Surface("east").setPlane(planes.levels.second.rooms.bathroom1.east)
          .setSize({w: rooms.L2.bathroom1.x, h: rooms.L2.bathroom1.h})
          .setWindows(new doug.Windows(["door"]).setWall(crap.levels.second.bedroom1.surfaces.west).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("south").setPlane(planes.levels.second.rooms.bathroom1.south)
          .setSize({w: rooms.L2.bathroom1.y, h: rooms.L2.bathroom1.h})
          .setWindows(new doug.Windows(["w4"]).setWall(southWall.surfaces.main).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("west").setPlane(planes.levels.second.rooms.bathroom1.west)
          .setSize({w: bathroom1L2WestWallWidth, h: rooms.L2.bathroom1.h})
        )
        .addInteriorSurface(new doug.Surface("north").setPlane(planes.levels.second.rooms.bathroom1.north)
          .setSize({w: bathroom1L2NorthWallWidth, h: rooms.L2.bathroom1.h})
          .setWindows(new doug.Windows(["door"]))
        )
      ;

      crap.levels.second.bedroom2 = new doug.WallSystem("bedroom1L2").setPlane(planes.levels.second.rooms.bedroom2.west)
        .setInteriorMaterial(materials.plaster)
        .addWindow(new doug.Window("door").setSize({w: 94, h: 205}).setOffset({x: 20+10, z: 0}))
        .addWindow(new doug.Window("nook1").setSize({w: 120, h: 100}).setOffset({y: 90, z: 0}))
        .addWindow(new doug.Window("nook2").setSize({w: 121, h: 300}).setOffset({y: 10, z: 0}))
        .addInteriorSurface(new doug.Surface("east").setPlane(planes.levels.second.rooms.bedroom2.east)
          .setSize({w: rooms.L2.bedroom2.x, h: rooms.L2.bedroom2.h})
          .setWindows(new doug.Windows(["leftL2BR", "rightL2BR"]).setWall(eastWall.surfaces.main).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("south").setPlane(planes.levels.second.rooms.bedroom2.south)
          .setSize({w: rooms.L2.bedroom2.y, h: rooms.L2.bedroom2.h})
          .setWindows(new doug.Windows(["nook1"]))
        )
        .addInteriorSurface(new doug.Surface("west").setPlane(planes.levels.second.rooms.bedroom2.west)
          .setSize({w: rooms.L2.bedroom2.x, h: rooms.L2.bedroom2.h})
          .setWindows(new doug.Windows(["door"]))
        )
        .addInteriorSurface(new doug.Surface("north").setPlane(planes.levels.second.rooms.bedroom2.north)
          .setSize({w: rooms.L2.bedroom2.y, h: rooms.L2.bedroom2.h})
          .setWindows(new doug.Windows(["nook2"]))
        )
      ;

      crap.levels.second.bathroom2 = new doug.WallSystem("bathroom2L2")
        .setPlane(planes.levels.second.rooms.bathroom2.east)
        .setInteriorMaterial(materials.plaster)
        .addWindow(new doug.Window("door").setSize({w: 183, h: 205}).setOffset({y: 76, z: 0}))
        // .addWindow(new doug.Window("window").setSize({w: 90, h: 125}).setOffset({x: rooms.L2.bathroom2.x-313+30, z: 50}))
        .addWindow(new doug.Window("nook").setSize({w: 30, h: 30}).setOffset({y: 140, z: 160}))
        .addInteriorSurface(new doug.Surface("east").setPlane(planes.levels.second.rooms.bathroom2.east)
          .setSize({w: rooms.L2.bathroom2.x, h: rooms.L2.bathroom2.h})
          .setWindows(new doug.Windows(["door"]).setWall(crap.levels.second.bedroom2.surfaces.west).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("south").setPlane(planes.levels.second.rooms.bathroom2.south)
          .setSize({w: rooms.L2.bathroom2.y, h: rooms.L2.bathroom2.h})
          .setWindows(new doug.Windows(["door"]))
        )
        .addInteriorSurface(new doug.Surface("west").setPlane(planes.levels.second.rooms.bathroom2.west)
          .setSize({w: bathroom2L2WestWallWidth, h: rooms.L2.bathroom2.h})
          .setWindows(new doug.Windows(["w2"]).setWall(westWall.surfaces.main).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("north").setPlane(planes.levels.second.rooms.bathroom2.north)
          .setSize({w: bathroom2L2NorthWallWidth, h: rooms.L2.bathroom2.h})
          .setWindows(new doug.Windows(["nook"]))
        )
      ;

      crap.levels.second.landing = new doug.WallSystem("landingL2")
        .setInteriorMaterial(materials.plaster)
        .addWindow(new doug.Window("door").setSize({w: rooms.L2.landing.x, h: rooms.L2.landing.h}).setOffset({x: 0, z: 0}))
        .addInteriorSurface(new doug.Surface("east").setPlane(planes.levels.second.rooms.landing.east)
          .setSize({w: rooms.L2.landing.x, h: rooms.L2.landing.h})
          .setWindows(new doug.Windows(["door"]))
        )
        .addInteriorSurface(new doug.Surface("south").setPlane(planes.levels.second.rooms.landing.south)
          .setSize({w: rooms.L2.landing.y, h: rooms.L2.landing.h})
          .setWindows(new doug.Windows(["door"]).setWall(crap.levels.second.bathroom1.surfaces.north).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("west").setPlane(planes.levels.second.rooms.landing.west)
          .setSize({w: landingL2WestWallWidth, h: rooms.L2.landing.h})
          .setWindows(new doug.Windows(["w1"]).setWall(westWall.surfaces.main).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("north").setPlane(planes.levels.second.rooms.landing.north)
          .setSize({w: landingL2NorthWallWidth, h: rooms.L2.landing.h})
          .setWindows(new doug.Windows(["door"]).setWall(crap.levels.second.bathroom2.surfaces.south).setJambsAll())
        )
      ;

      crap.levels.second.landingL3 = new doug.WallSystem("landingL3")
        .setInteriorMaterial(materials.plaster)
        .addWindow(new doug.Window("door").setSize({w: rooms.L3.landing.x, h: rooms.L3.landing.h}).setOffset({x: 0, z: 0}))
        .addInteriorSurface(new doug.Surface("east").setPlane(planes.levels.third.rooms.landing.east)
          .setSize({w: rooms.L3.landing.x, h: rooms.L3.landing.h})
          .setWindows(new doug.Windows(["stairL2"]).setWall(eastWall.surfaces.main).setJambsAll())
        )
        .addInteriorSurface(new doug.Surface("south").setPlane(planes.levels.third.rooms.landing.south)
          .setSize({w: rooms.L3.landing.y, h: rooms.L3.landing.h})
        )
        .addInteriorSurface(new doug.Surface("west").setPlane(planes.levels.third.rooms.landing.west)
          .setSize({w: rooms.L3.landing.x, h: rooms.L3.landing.h})
          .setWindows(new doug.Windows(["door"]))
        )
        .addInteriorSurface(new doug.Surface("north").setPlane(planes.levels.third.rooms.landing.north)
          .setSize({w: rooms.L3.landing.y, h: rooms.L3.landing.h})
        )
      ;


      //Floors
      // var floors = new doug.WallSystem("Floors")
      //   .addHorizontalSurface(new Floor("cellar1Floor").setPlane(planes.levels.ground.rooms.cellar1.east)
      //     .setSize({w: rooms.L0.cellar1.w, h: rooms.L0.cellar1.y})
      //   )
      //   .addHorizontalSurface(new Ceiling("cellar1Ceiling").setPlane(planes.levels.ground.rooms.cellar1.east)
      //     .setSize({w: rooms.L0.cellar1.w, h: rooms.L0.cellar1.y})
      //     .setOffset({x: 0, y: 0, z: rooms.L0.cellar1.h})
      //     .flip()
      //   )
      //   .addHorizontalSurface(new Floor("cellar2frontFloor").setPlane(planes.levels.ground.rooms.cellar2front.east)
      //     .setSize({w: rooms.L0.cellar2front.w, h: rooms.L0.cellar2front.y})
      //   )
      //   .addHorizontalSurface(new Ceiling("cellar2frontCeiling").setPlane(planes.levels.ground.rooms.cellar2front.east)
      //     .setSize({w: rooms.L0.cellar2front.w, h: rooms.L0.cellar2front.y})
      //     .setOffset({x: 0, y: 0, z: rooms.L0.cellar2front.h})
      //     .flip()
      //   )
          // .setPlane(new doug.Plane().setFacingDirection([0,0,1]).setOriginOffset([0,0,0]).setRotationZ(0))
        // .addInteriorHorizontalSurface(new Floor("floor0")
        //   .setSize({w: rooms.L0.cellar.w, h: rooms.L0.cellar.y})
        //   .setOffset(roomWallOffset({level: "L0", room: "cellar", sides: {x: "south", y: "east"}}))
        // )
        // .addInteriorHorizontalSurface(new Ceiling("ceiling0")
        //   .setSize({w: rooms.L0.cellar.w, h: rooms.L0.cellar.y})
        //   .setOffset(roomWallOffset({level: "L0", room: "cellar", sides: {x: "south", y: "east"}}, {x: 0, y: 0, z: rooms.L0.cellar.h}))
        //   .flip()
        // )
        // .addInteriorHorizontalSurface(new Floor("floor1")
        //   .setSize({w: rooms.L1.living.w, h: rooms.L1.living.y})
        //   .setOffset(roomWallOffset({level: "L1", room: "living", sides: {x: "south", y: "east"}}))
        // )
        // .addInteriorHorizontalSurface(new Ceiling("ceiling1")
        //   .setSize({w: rooms.L1.living.w, h: rooms.L1.living.y})
        //   .setOffset(roomWallOffset({level: "L1", room: "living", sides: {x: "south", y: "east"}}, {x: 0, y: 0, z: rooms.L1.living.h}))
        //   .flip()
        // )
        // .addInteriorHorizontalSurface(new Floor("floor2")
        //   .setSize({w: rooms.L2.bedroom.w, h: rooms.L2.bedroom.y})
        //   .setOffset(roomWallOffset({level: "L2", room: "bedroom", sides: {x: "south", y: "east"}}))
        // )
        // .addInteriorHorizontalSurface(new Ceiling("ceiling2")
        //   .setSize({w: rooms.L2.bedroom.w, h: rooms.L2.bedroom.y})
        //   .setOffset(roomWallOffset({level: "L2", room: "bedroom", sides: {x: "south", y: "east"}}, {x: 0, y: 0, z: rooms.L2.bedroom.h}))
        //   .flip()
        // )
      // ;
      // shaper0.wallSystem(floors);


      crap.levels.ground.cellar1.call(shaper0.wallSystem);
      crap.levels.ground.cellar2front.call(shaper0.wallSystem);
      crap.levels.ground.cellar2back.call(shaper0.wallSystem);
      crap.levels.ground.hall.call(shaper0.wallSystem);
      crap.levels.ground.cellar3.call(shaper0.wallSystem);
      crap.levels.first.living1.call(shaper0.wallSystem);
      crap.levels.first.living2.call(shaper0.wallSystem);
      crap.levels.first.bedroom.call(shaper0.wallSystem);
      crap.levels.first.bathroom.call(shaper0.wallSystem);
      crap.levels.first.entry.call(shaper0.wallSystem);
      crap.levels.first.kitchen.call(shaper0.wallSystem);
      crap.levels.first.landing.call(shaper0.wallSystem);
      crap.levels.second.bedroom1.call(shaper0.wallSystem);
      crap.levels.second.bathroom1.call(shaper0.wallSystem);
      crap.levels.second.bedroom2.call(shaper0.wallSystem);
      crap.levels.second.bathroom2.call(shaper0.wallSystem);
      crap.levels.second.landing.call(shaper0.wallSystem);
      crap.levels.second.landingL3.call(shaper0.wallSystem);






      // var eastPerimeter = new doug.WallSystem("East Perimeter")
      //   .addWindow(new doug.Window("gate").setSize({w: 314, h: 200}).setOffset({x: 1817, z: 0}))
      //   .setExteriorMaterial(materials.stone)
      //   .addExteriorSurface(new doug.Surface("main").setPlane(planes.levels.ground.perimeter.east)
      //     .setSize({w: 2532, h: 200})
      //     .setWindows(new doug.Windows(["gate"]))
      //   )
      //   .setInteriorMaterial(materials.stone)
      //   .addInteriorSurface(new doug.Surface("inside").setPlane(planes.levels.ground.perimeter.east)
      //     .setSize({w: 2532-20-20, h: 200})
      //     .setOffset({x: 20, y: 20, z: 0})
      //     .setWindows(new doug.Windows(["gate"]).setJambsAll())
      //   )
      // ;
      // shaper0.wallSystem(eastPerimeter);
      // var northPerimeter = new doug.WallSystem("North Perimeter")
      //   .setExteriorMaterial(materials.stone)
      //   .addExteriorSurface(new doug.Surface("main").setPlane(planes.levels.ground.perimeter.north)
      //     .setSize({w: 1143, h: 200})
      //   )
      //   .setInteriorMaterial(materials.stone)
      //   .addInteriorSurface(new doug.Surface("inside").setPlane(planes.levels.ground.perimeter.north)
      //     .setSize({w: 1143-20, h: 200})
      //     .setOffset({x: -20, y: 0, z: 0})
      //   )
      // ;
      // shaper0.wallSystem(northPerimeter);
      // var southPerimeter = new doug.WallSystem("South Perimeter")
      //   .setExteriorMaterial(materials.stone)
      //   .addExteriorSurface(new doug.Surface("main").setPlane(planes.levels.ground.perimeter.south)
      //     .setSize({w: 2741, h: 200})
      //   )
      //   .setInteriorMaterial(materials.stone)
      //   .addInteriorSurface(new doug.Surface("inside").setPlane(planes.levels.ground.perimeter.south)
      //     .setSize({w: 2741-20-20, h: 200})
      //     .setOffset({x: 20, y: 20, z: 0})
      //   )
      // ;
      // shaper0.wallSystem(southPerimeter);
      // var westPerimeter = new doug.WallSystem("West Perimeter")
      //   .setExteriorMaterial(materials.stone)
      //   .addExteriorSurface(new doug.Surface("main").setPlane(planes.levels.ground.perimeter.west)
      //     .setSize({w: 2117, h: 200})
      //   )
      //   .setInteriorMaterial(materials.stone)
      //   .addInteriorSurface(new doug.Surface("inside").setPlane(planes.levels.ground.perimeter.west)
      //     .setSize({w: 2117-20, h: 200})
      //     .setOffset({x: 20, y: -20, z: 0})
      //   )
      // ;
      // shaper0.wallSystem(westPerimeter);

//###############
      //Axes
      scene.add(line([[-200,0,0],[0,0,0]],0xff8888));
      scene.add(line([[   0,0,0],[1700,0,0]],0xff0000));
      // scene.add(line([[1,0,0],[1,-.1,0]],0xff0000));
      // scene.add(line([[2,0,0],[2,-.1,0]],0xff0000));
      // scene.add(line([[3,0,0],[3,-.1,0]],0xff0000));

      scene.add(line([[0,-100,0],[0,   0,0]],0x88ff88));
      scene.add(line([[0,   0,0],[0,1800,0]],0x00ff00));

      scene.add(line([[0,0,-100],[0,0,   0]],0x8888ff));
      scene.add(line([[0,0,   0],[0,0,1200]],0x0000ff));
      // scene.add(line([[0,0,1],[0,-.1,1]],0x0000ff));
      // scene.add(line([[0,0,2],[0,-.1,2]],0x0000ff));
      // scene.add(line([[0,0,3],[0,-.1,3]],0x0000ff));

      var color = 0xfdf3c6;
      var intensity = .3;
      const ambientLight = new _3js.AmbientLight(color, intensity);
      scene.add(ambientLight);


      var eastlight = new _3js.SpotLight(0xfdf3c6, .5, 100, Math.PI/4);
      eastlight.position.set(500,-1800,100);
      eastlight.target.position.set(500,-1143, 100);
      eastlight.updateMatrixWorld();
      eastlight.target.updateMatrixWorld();
      scene.add( eastlight );
      // scene.add( eastlight.target );
      const spotLightHelper = new _3js.SpotLightHelper( eastlight );
      scene.add( spotLightHelper );

      var light = new _3js.SpotLight(0xfdf3c6, .5, 10000, Math.PI/4);
      light.position.set(-2000,-2000,1400);
      light.target.position.set(0,0,450);
      light.target.updateMatrixWorld();
      // light.castShadow = true;
      // light.shadow.bias = -0.0001;
      var light2 = new _3js.SpotLight(0xfdf3c6, .5, 10000, Math.PI/4);
      light2.position.set(3500,2900,1400);
      light2.target.position.set(1500,900,450);
      light2.target.updateMatrixWorld();
      // light2.castShadow = true;
      // light2.shadow.bias = -0.0001;
      scene.add( light2 );
      scene.add( light );

      const lightBulb = new _3js.PointLight( 0xffffff, .5, 100, 2 );
      lightBulb.position.set( 750, 200, 500 );
      // scene.add( lightBulb );

      // const helper = new _3js.SpotLightHelper( light, 5);
      // scene.add( helper );
      // const shhelper = new _3js.CameraHelper(light.shadow.camera);
      // scene.add( shhelper );

      // view.setScene(scene);
      // view.lake();

      // function render(time) {
      //   time *= 0.001;  // convert time to seconds
      //
      //   cubes.forEach((cube, ndx) => {
      //     const speed = 1 + ndx * .1;
      //     const rot = time * speed;
      //     cube.rotation.x = rot;
      //     cube.rotation.y = rot;
      //   });
      //
      //   renderer.render(scene, camera);
      //   // requestAnimationFrame(render);
      // }
      function render(time) {

        // console.log(50/Math.tan(37.5*Math.PI/180));
        time *= 0.001;  // convert time to seconds
        const speed = .5;
        const rot = time * speed;
        // camera.position.set(0,7,0);
        var vector = new _3js.Vector3( 0, -40, 1 );
        var axis = new _3js.Vector3( 0, 0, 1 );
        var angle = rot+3.5*Math.PI/180;
        // console.log(rot);
        angle = rot;
        // angle = .72*Math.PI/1;//look at back corner
        // angle = .26*Math.PI/1;//Look at frnt left cornice
        // angle = -.1*Math.PI/1;//Look at frnt right cornice
        // angle = 1.0*Math.PI;//Look at frnt right cornice
        // angle = 0;
        vector.applyAxisAngle( axis, angle );
        // console.log(vector);
        // camera.position.set(vector.x,vector.y,vector.z);

        // console.log(rot);
        //Outside
        // var dist = -1900;
        // camera2([450+dist*Math.sin(angle),450+dist*Math.cos(angle),700-800*Math.sin(angle)], [750,500,500], 80);
        // camera2([750+dist*Math.sin(angle),450+dist*Math.sin(angle+Math.PI/2),500+2000*Math.sin(angle/4)], [750,500,500], 80);
        // camera.position.set(450+dist*Math.sin(angle),450+dist*Math.cos(angle),700-800*Math.sin(angle));//450
        // camera.lookAt(750,500,500);
        // camera.position.set(450+dist*Math.sin(angle),450+dist*Math.cos(angle),0);//450

        //inside first floor
        // var dist = 10;
        // camera.position.set(450+dist*Math.sin(angle),450+dist*Math.cos(angle),200+90*Math.sin(angle/2));//450
        // camera.lookAt(450,450,200+90*Math.sin(angle/2));
        // camera.position.set(450+dist*Math.sin(angle),450+dist*Math.cos(angle),100);//450
        // camera.lookAt(450,450,100);

        //front right corner
        // camera.position.set(900-5, 0+5,200);
        // camera.lookAt(900-35,0+35,500);
        // camera2([wallW, 0, wallH+200], [wallW, 0, wallH], 30);//Top
        // camera2([eastWallWidth+50, 0-30, eastWallWidth+20], [eastWallWidth, 0, eastWallWidth], 30);

        //front left corner
        // camera.position.set(0+5, 0+5,200);
        // camera.lookAt(0+35,0+35,500);
        // camera2([0+10, 0+10, wallH+200], [0, 0, wallH], 30);//Top
        // camera2([0-80, 0-120, 1270], [0, 0, 1060], 30);

        //back right corner
        // camera.position.set(900-5, 700-5,200);
        // camera.lookAt(900-35,700-35,500);
        // camera2([900-5, 700-5,0], [900-35,700-35,500], 30)

        //back left corner
        // camera.position.set(0+5, 900-5,200);//450
        // camera.lookAt(0+35,900-35,500);
        // camera2([0-50, 942+15, 1033+18+8+5+6+6+6+18+150], [0,942+15,1033+18+8+5+6+6+6+18], 30)

        // console.log(camera.position);
        // vector.applyAxisAngle( axis, angle );
        // camera.translateOnAxis(vector, 7);

        // renderer.render(scene, camera);
        control.positionCamera();
        composer.render();
        // controls.update(.01);
        // requestAnimationFrame(render);
      }
      requestAnimationFrame(render);
      // renderer.render(scene, camera);

      // var vector = new _3js.Vector3( 0, 1, 0 );
      // var axis = new _3js.Vector3( 0, 0, 1 );
      // var angle = Math.PI / 4;
      // vector.applyAxisAngle( axis, angle );
      // console.log(vector);
    }

    main();
  </script>

</body>
